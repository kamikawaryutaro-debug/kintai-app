<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± å‡ºé€€å‹¤ã‚¢ãƒ—ãƒªï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆï¼‰</title>
    <!-- Firebase SDK (Version 8 - Stable) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .connection-status {
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        input,
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .btn-checkin {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-checkout {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .btn-paid {
            background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.show {
            display: block;
        }

        .recent-records {
            max-height: 300px;
            overflow-y: auto;
        }

        .record-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .record-item.paid {
            border-left-color: #ff9966;
        }

        .manual-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± å‡ºé€€å‹¤ã‚¢ãƒ—ãƒª</h1>
            <p class="subtitle">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸç‰ˆ</p>
        </div>
        <div class="connection-status disconnected" id="connectionStatus">âš ï¸ æ¥ç¶šç¢ºèªä¸­...</div>
        <div class="card">
            <h3 style="text-align: center; margin-bottom: 15px; color: #555;" id="currentTime">--:--:--</h3>
            <div class="status" id="status"></div>
            <form id="attendanceForm">
                <div class="form-group">
                    <label>ğŸ¢ ç‰©ä»¶åãƒ»ç¾å ´</label>
                    <button type="button" id="regionFilterBtn"
                        style="width:100%; padding:10px; margin-bottom:5px; background:#eee; border:none; border-radius:8px;">ğŸŒ
                        åœ°åŒºã§çµã‚Šè¾¼ã¿</button>
                    <select id="location" required onchange="onLocationChange()">
                        <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸ‘¤ æ°å</label>
                    <select id="employeeName" required>
                        <option value="">å…ˆã«ç‰©ä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <!-- Custom Name -->
                <div class="form-group" id="customNameGroup" style="display:none;">
                    <input type="text" id="customName" placeholder="æ°åã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label>â° å‹¤å‹™æ™‚é–“</label>
                    <select id="shiftTimeSelect" onchange="onShiftChange()">
                        <option value="">å…ˆã«ç‰©ä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <div class="manual-inputs" id="manualTimeInputs" style="display:none;">
                        <input type="text" id="startTime" placeholder="é–‹å§‹ 09:00">
                        <input type="text" id="endTime" placeholder="çµ‚äº† 18:00">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-checkin" id="checkinBtn"><span>âœ“</span>å‡ºå‹¤</button>
                    <button type="button" class="btn btn-checkout" id="checkoutBtn"><span>â†’</span>é€€å‹¤</button>
                    <button type="button" class="btn btn-paid" id="paidLeaveBtn"><span>ğŸ–ï¸</span>æœ‰çµ¦</button>
                </div>
                <div id="paidLeaveAlert"
                    style="display:none; margin-top:10px; color:red; text-align:center; font-weight:bold;">âš ï¸ æœ¬æ—¥æœ‰çµ¦å–å¾—æ¸ˆã¿
                </div>
            </form>
        </div>
        <div class="card">
            <h3>ğŸ“‹ æœ€è¿‘ã®è¨˜éŒ²</h3>
            <div class="recent-records" id="recentRecords"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="regionModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:15px; width:90%; max-width:400px;">
            <h3>åœ°åŒºã‚’é¸æŠ</h3>
            <div id="regionList" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin:15px 0;">
            </div>
            <button onclick="document.getElementById('regionModal').style.display='none'"
                style="width:100%; padding:10px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="paidLeaveModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:15px; width:90%; max-width:400px;">
            <h3 style="text-align:center; color:#ff5e62;">ğŸ–ï¸ æœ‰çµ¦ç”³è«‹</h3>
            <p id="paidLeaveNameDisplay" style="text-align:center; font-weight:bold; margin:10px 0;"></p>
            <input type="date" id="paidLeaveDate"
                style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="document.getElementById('paidLeaveModal').style.display='none'"
                    style="padding:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitPaidLeave()"
                    style="padding:10px; background:#ff5e62; color:white; border:none; font-weight:bold; border-radius:5px;">ç”³è«‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šã‚¨ãƒªã‚¢ (ã‚ãªãŸã®æ–°ã—ã„Firebaseè¨­å®š) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAw1iVKGUXBAszbW4Va1HwdwZbjLeNTFIQ",
            authDomain: "attendance-system-12c02.firebaseapp.com",
            databaseURL: "https://attendance-system-12c02-default-rtdb.firebaseio.com",
            projectId: "attendance-system-12c02",
            storageBucket: "attendance-system-12c02.firebasestorage.app",
            messagingSenderId: "64755412792",
            appId: "1:64755412792:web:988791ca6fe9151998dbcd",
            measurementId: "G-QY6PRHV8HJ"
        };
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLl_x_3e56t-V9c3FmaCSbe5XzcWFZFZqUnUZU3LxT78bQpnJcsGIoXhcD0W2pozqyCA/exec';

        let database = null;
        let masterData = [];
        let regions = {};
        let currentFilterRegion = null;

        // åˆæœŸåŒ–ï¼†ãƒ­ã‚°ã‚¤ãƒ³
        try {
            firebase.initializeApp(firebaseConfig);
            firebase.auth().signInAnonymously().then(() => {
                console.log('Logged in');
                database = firebase.database();
                updateConnectionStatus(true);
                initDataListeners();
            }).catch(e => {
                console.error(e);
                updateConnectionStatus(false, e.message);
            });
        } catch (e) { updateConnectionStatus(false, "è¨­å®šã‚¨ãƒ©ãƒ¼: " + e.message); }

        function updateConnectionStatus(connected, msg) {
            const el = document.getElementById('connectionStatus');
            if (connected) { el.textContent = 'âœ“ ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šå®Œäº†'; el.className = 'connection-status connected'; }
            else { el.textContent = 'âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + (msg || ''); el.className = 'connection-status disconnected'; }
        }

        function initDataListeners() {
            database.ref('masterData').on('value', snap => {
                const val = snap.val();
                console.log("MasterData loaded:", val); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                masterData = val ? Object.keys(val).map(k => ({ id: k, ...val[k] })) : [];
                updateLocationSelect();
            });
            database.ref('regions').on('value', snap => {
                regions = snap.val() || {};
                renderRegionModal();
            });
            // Recent Records listener
            database.ref('attendance').orderByChild('timestamp').limitToLast(10).on('value', snap => {
                const arr = [];
                snap.forEach(c => { arr.push(c.val()); });
                renderRecs(arr.reverse());
            });
        }

        function onLocationChange() {
            const siteId = document.getElementById('location').value;
            const empSelect = document.getElementById('employeeName');
            const shiftSelect = document.getElementById('shiftTimeSelect');
            empSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            shiftSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option><option value="custom">ãã®ä»–ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</option>';

            if (!siteId) return;
            const site = masterData.find(s => s.id == siteId);
            if (site && site.employees) {
                site.employees.forEach(e => {
                    const opt = document.createElement('option'); opt.value = e; opt.textContent = e; empSelect.appendChild(opt);
                });
            }
            const custOpt = document.createElement('option'); custOpt.value = 'custom'; custOpt.textContent = 'ãã®ä»–ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰'; empSelect.appendChild(custOpt);

            if (site && site.shifts) {
                const customOpt = shiftSelect.querySelector('option[value="custom"]');
                site.shifts.forEach(s => {
                    const opt = document.createElement('option'); opt.value = s; opt.textContent = s; shiftSelect.insertBefore(opt, customOpt);
                });
            }
        }

        function updateLocationSelect() {
            const select = document.getElementById('location');
            const cur = select.value;
            let list = currentFilterRegion ? masterData.filter(s => s.region === currentFilterRegion) : masterData;

            if (list.length === 0) select.innerHTML = '<option value="">(ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“)</option>';
            else select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + list.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            if (cur && list.some(s => s.id === cur)) select.value = cur;
        }

        document.getElementById('regionFilterBtn').onclick = () => document.getElementById('regionModal').style.display = 'flex';
        function renderRegionModal() {
            const box = document.getElementById('regionList');
            const abc = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            box.innerHTML = `<button onclick="applyRegion(null)" style="grid-column:1/-1; padding:8px; background:#667eea; color:white; border:none; border-radius:5px;">ã™ã¹ã¦è¡¨ç¤º</button>` +
                abc.map(c => `<button onclick="confirmRegion('${c}')" style="padding:8px; background:white; border:1px solid #ddd;">${c}</button>`).join('');
        }
        function confirmRegion(id) {
            const name = regions[id] || id;
            if (confirm(`${name} ã§çµã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) { applyRegion(id); }
        }
        function applyRegion(id) {
            currentFilterRegion = id;
            document.getElementById('regionFilterBtn').textContent = id ? `ğŸŒ åœ°åŒº: ${regions[id] || id}` : 'ğŸŒ åœ°åŒºã§çµã‚Šè¾¼ã¿';
            updateLocationSelect();
            document.getElementById('regionModal').style.display = 'none';
        }

        setInterval(() => {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('ja-JP');
        }, 1000);

        document.getElementById('employeeName').onchange = (e) => {
            document.getElementById('customNameGroup').style.display = e.target.value === 'custom' ? 'block' : 'none';
            checkPaidLeave();
        };
        document.getElementById('customName').oninput = checkPaidLeave;

        document.getElementById('shiftTimeSelect').onchange = (e) => {
            const manual = document.getElementById('manualTimeInputs');
            const val = e.target.value;
            if (val === 'custom') {
                manual.style.display = 'grid';
            } else {
                manual.style.display = 'none';
                if (val) {
                    const parts = val.split(/[ï½~-]/);
                    if (parts.length >= 2) {
                        document.getElementById('startTime').value = parts[0].trim();
                        document.getElementById('endTime').value = parts[1].trim();
                    }
                }
            }
        };

        document.getElementById('checkinBtn').onclick = () => record('checkin');
        document.getElementById('checkoutBtn').onclick = () => record('checkout');
        document.getElementById('paidLeaveBtn').onclick = () => {
            const name = getName();
            if (!name) return alert('æ°åã‚’é¸æŠã—ã¦ãã ã•ã„');
            document.getElementById('paidLeaveNameDisplay').textContent = name;
            const now = new Date();
            const localToday = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            document.getElementById('paidLeaveDate').value = localToday;
            document.getElementById('paidLeaveModal').style.display = 'flex';
        }

        function getName() {
            const val = document.getElementById('employeeName').value;
            return val === 'custom' ? document.getElementById('customName').value : val;
        }

        async function record(type) {
            const siteId = document.getElementById('location').value;
            if (!siteId) return alert('ç‰©ä»¶ã‚’é¸ã‚“ã§ãã ã•ã„');
            const name = getName();
            if (!name) return alert('æ°åãŒå¿…è¦ã§ã™');
            const shift = document.getElementById('shiftTimeSelect').value;
            if (type !== 'paid_leave' && !shift) return alert('æ™‚é–“ã‚’é¸ã‚“ã§ãã ã•ã„');

            const now = new Date();
            const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            if (type !== 'paid_leave' && await hasConflict(name, today, ['paid_leave'])) {
                return alert('æœ¬æ—¥ã¯æœ‰çµ¦ã®ãŸã‚å‡ºå‹¤ã§ãã¾ã›ã‚“');
            }

            const siteName = document.getElementById('location').options[document.getElementById('location').selectedIndex].text;
            if (!confirm(`${siteName} ã§ ${type === 'checkin' ? 'å‡ºå‹¤' : 'é€€å‹¤'} ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const data = {
                id: Date.now(),
                name: name,
                date: today,
                location: siteName,
                startTime: document.getElementById('startTime').value || '-',
                endTime: document.getElementById('endTime').value || '-',
                type: type,
                timestamp: new Date().toISOString(),
                recordedTime: new Date().toLocaleString('ja-JP')
            };

            send(data);
        }

        async function submitPaidLeave() {
            const name = document.getElementById('paidLeaveNameDisplay').textContent;
            const date = document.getElementById('paidLeaveDate').value;
            const siteId = document.getElementById('location').value;
            if (!siteId) return alert('ç‰©ä»¶ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæ‰€å±ç”¨ï¼‰');
            const siteName = document.getElementById('location').options[document.getElementById('location').selectedIndex].text;

            if (!confirm(`${date} ã«æœ‰çµ¦ã‚’ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const startTime = document.getElementById('startTime').value || '-';
            const endTime = document.getElementById('endTime').value || '-';

            const data = {
                id: Date.now(),
                name: name,
                date: date,
                location: siteName,
                startTime: startTime,
                endTime: endTime,
                type: 'paid_leave',
                timestamp: new Date().toISOString(),
                recordedTime: new Date().toLocaleString('ja-JP')
            };

            document.getElementById('status').textContent = 'ç¢ºèªä¸­...';
            document.getElementById('status').className = 'status show';
            try {
                const res = await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
                const json = await res.json();
                if (json.success === false) {
                    const errorMsg = json.message || 'æœ‰çµ¦ãŒå–ã‚Œã¾ã›ã‚“ã€æ‹…å½“è€…ã«é€£çµ¡ã‚’ã—ã¦ãã ã•ã„ã€‚';
                    showMessage(errorMsg, 'error');
                    alert(errorMsg);
                    return;
                }
            } catch (e) {
                if (!confirm("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å¼·åˆ¶è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
            }

            send(data);
            document.getElementById('paidLeaveModal').style.display = 'none';
        }

        function send(data) {
            showMessage('é€ä¿¡ä¸­...', 'success');
            if (database) database.ref('attendance/' + data.id).set(data);
            fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) })
                .then(r => r.json())
                .then(j => {
                    if (j.limitExceeded) showMessage(j.message, 'error');
                    else showMessage('è¨˜éŒ²ã—ã¾ã—ãŸ', 'success');
                })
                .catch(e => showMessage('è¨˜éŒ²ã—ã¾ã—ãŸ(GASé€šä¿¡ã‚¨ãƒ©ãƒ¼)', 'success'));

            let local = JSON.parse(localStorage.getItem('recs') || '[]');
            local.push(data);
            localStorage.setItem('recs', JSON.stringify(local));

            if (data.type !== 'paid_leave') {
                // reset form
            }
        }

        function showMessage(txt, type) {
            const el = document.getElementById('status');
            el.textContent = txt;
            el.className = `status ${type} show`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        async function displayRecentRecords() {
            const div = document.getElementById('recentRecords');
            if (database) {
                database.ref('attendance').orderByChild('timestamp').limitToLast(10).once('value').then(s => {
                    const arr = []; s.forEach(c => arr.push(c.val()));
                    renderRecs(arr.reverse());
                });
            }
        }
        function renderRecs(list) {
            const div = document.getElementById('recentRecords');
            if (!list.length) { div.innerHTML = '<p style="text-align:center;color:#999">è¨˜éŒ²ãªã—</p>'; return; }
            div.innerHTML = list.map(r => `
                <div class="record-item ${r.type}">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span style="color:${r.type === 'checkin' ? '#11998e' : r.type === 'checkout' ? '#ee0979' : '#ff6a00'}">
                            ${r.type === 'checkin' ? 'âœ“ å‡ºå‹¤' : r.type === 'checkout' ? 'â†’ é€€å‹¤' : 'ğŸ–ï¸ æœ‰çµ¦'}
                        </span>
                        <span style="font-size:0.8em; color:#666;">${r.recordedTime}</span>
                    </div>
                    <div style="font-size:0.9em; margin-top:5px;">
                        ${r.name} @ ${r.location}<br>
                        ${r.type === 'paid_leave' ? r.date : (r.startTime + 'ã€œ' + r.endTime)}
                    </div>
                </div>
            `).join('');
        }

        async function hasConflict(name, date, types) {
            return false;
        }

        async function checkPaidLeave() {
            const name = getName();
            const alertBox = document.getElementById('paidLeaveAlert');
            const btn = document.getElementById('paidLeaveBtn');
            if (!name || !database) return;
            const norm = n => n.replace(/[\sã€€]/g, '');
            const target = norm(name);
            const now = new Date();
            const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

            database.ref('attendance').orderByChild('date').equalTo(today).once('value').then(snap => {
                let taken = false;
                snap.forEach(c => {
                    const v = c.val();
                    if (v.type === 'paid_leave' && norm(v.name) === target) taken = true;
                });
                if (taken) {
                    alertBox.style.display = 'block';
                    btn.style.opacity = '0.5';
                    btn.disabled = true;
                } else {
                    alertBox.style.display = 'none';
                    btn.style.opacity = '1';
                    btn.disabled = false;
                }
            });
        }
    </script>
</body>

</html>